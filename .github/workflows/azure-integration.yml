name: MillennialAi Azure Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_to_azure:
        description: 'Deploy to Azure ML'
        required: false
        default: 'false'
        type: boolean

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_ML_WORKSPACE: ${{ secrets.AZURE_ML_WORKSPACE }}

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8
    
    - name: Lint with flake8
      run: |
        # Stop build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Treat all errors as warnings for now
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Test MillennialAi imports and basic functionality
      run: |
        python -c "
        import sys
        sys.path.append('.')
        
        # Test core imports
        from millennial_ai.config import HybridConfig
        from layer_injection_framework import LayerInjectionFramework
        
        # Test basic configuration
        config = HybridConfig()
        print(f'‚úÖ HybridConfig created: trm_hidden_size={config.trm_hidden_size}')
        
        # Test framework initialization (skip for CI - requires model download)
        print('‚úÖ LayerInjectionFramework import successful')
        
        print('üéâ All core MillennialAi components working!')
        "
    
    - name: Run unit tests
      run: |
        python -m pytest tests/ -v --cov=millennial_ai --cov-report=xml
      continue-on-error: true
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  azure-validation:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Azure CLI ML extension
      run: |
        az extension add --name ml --upgrade
    
    - name: Validate Azure resources
      run: |
        echo "üîç Setting subscription context..."
        az account set --subscription '${{ secrets.AZURE_SUBSCRIPTION_ID }}'
        
        echo "üîç Validating Azure ML workspace..."
        az ml workspace show \
          --name '${{ secrets.AZURE_ML_WORKSPACE }}' \
          --resource-group '${{ secrets.AZURE_RESOURCE_GROUP }}' \
          --subscription '${{ secrets.AZURE_SUBSCRIPTION_ID }}'
        
        echo "üîç Checking compute clusters..."
        az ml compute list \
          --workspace-name '${{ secrets.AZURE_ML_WORKSPACE }}' \
          --resource-group '${{ secrets.AZURE_RESOURCE_GROUP }}' \
          --subscription '${{ secrets.AZURE_SUBSCRIPTION_ID }}'
        
        echo "üîç Validating AI Foundry Hub..."
        az ml workspace show \
          --name '${{ secrets.AZURE_FOUNDRY_HUB }}' \
          --resource-group '${{ secrets.AZURE_RESOURCE_GROUP }}' \
          --subscription '${{ secrets.AZURE_SUBSCRIPTION_ID }}'
    
    - name: Test Azure ML job submission (dry run)
      run: |
        echo "üîç Installing Azure ML Python SDK..."
        pip install azure-ai-ml azure-identity
        
        echo "üîç Testing Azure ML client connection..."
        python -c "
        from azure.ai.ml import MLClient
        from azure.identity import DefaultAzureCredential
        
        credential = DefaultAzureCredential()
        ml_client = MLClient(
            credential=credential,
            subscription_id='${{ secrets.AZURE_SUBSCRIPTION_ID }}',
            resource_group_name='${{ secrets.AZURE_RESOURCE_GROUP }}',
            workspace_name='${{ secrets.AZURE_ML_WORKSPACE }}'
        )
        
        print('‚úÖ Azure ML client connection successful')
        print('‚úÖ Ready for job submission')
        "

  deploy:
    runs-on: ubuntu-latest
    needs: [test, azure-validation]
    if: github.ref == 'refs/heads/main' && github.event.inputs.deploy_to_azure == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        az extension add --name ml --upgrade
    
    - name: Submit Azure ML training job
      run: |
        echo "üöÄ Submitting MillennialAi training job to Azure ML..."
        python submit_azure_training.py
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        AZURE_ML_WORKSPACE_NAME: ${{ secrets.AZURE_ML_WORKSPACE }}

  gpu-quota-check:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Check GPU quota status
      run: |
        echo "üîç Checking GPU quota status..."
        az vm list-usage --location eastus2 \
          --query "[?contains(name.value,'NCSv3')]" \
          --output table
        
        echo "üí° If quota is still 0, GPU training not yet available"
        echo "‚úÖ CPU cluster training available"