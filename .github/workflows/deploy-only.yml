name: Deploy Only (No Tests)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: millennialai-rg-20251102-174920
  AZURE_CONTAINER_APP: millennialai-app
  ACR_NAME: millennialaiacr17621237
  IMAGE_NAME: millennialai

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Log deployment reason
      run: |
        echo "Deployment triggered by: ${{ github.actor }}"
        echo "Reason: ${{ github.event.inputs.reason }}"
        echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set Azure subscription
      run: |
        az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
        echo "Using subscription: $(az account show --query name -o tsv)"
    
    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest .
        docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
                   ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Push Docker image to ACR
      run: |
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
    
    - name: Deploy to Azure Container Apps
      run: |
        az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
        az containerapp update \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
    
    - name: Get deployment info
      run: |
        echo "::group::Container App Status"
        az containerapp show \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --subscription ${{ env.AZURE_SUBSCRIPTION_ID }} \
          --query "{name:name, fqdn:properties.configuration.ingress.fqdn, status:properties.runningStatus, revision:properties.latestRevisionName}" \
          --output table
        echo "::endgroup::"
        
        echo "::group::Application URL"
        FQDN=$(az containerapp show \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --subscription ${{ env.AZURE_SUBSCRIPTION_ID }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        echo "Health endpoint: https://${FQDN}/health"
        echo "Chat endpoint: https://${FQDN}/chat"
        echo "::endgroup::"
    
    - name: Wait for deployment
      run: |
        echo "Waiting 60 seconds for new revision to be ready..."
        sleep 60
    
    - name: Test health endpoint
      run: |
        FQDN=$(az containerapp show \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --subscription ${{ env.AZURE_SUBSCRIPTION_ID }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        
        echo "Testing health endpoint..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "https://${FQDN}/health" || echo "000")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "✅ Health check passed (HTTP $HTTP_CODE)"
        else
          echo "⚠️ Health check returned HTTP $HTTP_CODE"
          echo "Checking container logs..."
          az containerapp logs show \
            --name ${{ env.AZURE_CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --subscription ${{ env.AZURE_SUBSCRIPTION_ID }} \
            --tail 50 || true
        fi
